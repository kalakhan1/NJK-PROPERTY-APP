<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NJK PROPERTY | THE REAL ESTATE MAGAZINE (SPA)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    /* Global Styles & Navigation */
    body {
      font-family: Arial, sans-serif;
      background-color: #e6f0ff;
      margin: 0;
      padding: 0;
      color: #003366;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background-color: #004080;
      color: white;
      padding: 10px 20px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    nav {
      background-color: #003366;
      padding: 10px 20px;
      text-align: center;
      flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
      justify-content: center;
      display: flex;
    }

    nav button {
      background-color: #0066cc;
      color: white;
      border: none;
      padding: 8px 12px; /* Smaller padding for mobile */
      margin: 5px; /* Adjust margin for wrapped buttons */
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px; /* Smaller font size for mobile */
      transition: background-color 0.3s ease;
      flex-grow: 1; /* Allow buttons to grow and fill space */
      min-width: 120px; /* Minimum width for buttons */
    }

    @media (min-width: 768px) {
      nav button {
        padding: 10px 15px; /* Larger padding for desktop */
        font-size: 16px; /* Larger font size for desktop */
        min-width: auto; /* Reset min-width for desktop */
        flex-grow: 0;
      }
    }

    nav button:hover {
      background-color: #0080ff;
    }

    /* Page Section Styling */
    .page-section {
      padding: 20px;
      display: none; /* Hidden by default, shown by JavaScript */
      background: #f0f7ff; /* Consistent background for content areas */
      flex-grow: 1; /* Allows content to take up available space */
      box-sizing: border-box;
      overflow-y: auto; /* Enable scrolling for content within sections */
    }

    .page-section.active {
      display: block;
    }

    h1, h2, p {
      text-align: center;
    }

    /* Styles from Page 1 (Property Submission Form) */
    #submit-property-section form {
      max-width: 800px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    #submit-property-section label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    #submit-property-section input,
    #submit-property-section select,
    #submit-property-section textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    #submit-property-section button[type="submit"] {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #004080;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #submit-property-section button[type="submit"]:hover {
      background-color: #0066cc;
    }
    #submit-property-section .hidden { display: none; }
    #submitMsg {
      text-align: center;
      color: green;
      font-weight: bold;
      margin-top: 20px;
    }

    /* Styles from Page 2 (Archive List) */
    #archive-section .archive-list {
      display: grid;
      grid-template-columns: repeat(1, 1fr);
      gap: 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    @media (min-width: 768px) {
      #archive-section .archive-list {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (min-width: 1024px) {
      #archive-section .archive-list {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    #archive-section .archive-item {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      position: relative;
    }
    /* Hide Bedrooms filter by default */
    .filter-item.bedrooms-filter {
        display: none;
    }

    /* Styles from Page 3 (Recent Carousel) */
    #recent-carousel-section .carousel-container {
      display: flex;
      overflow-x: auto;
      gap: 15px;
      padding-bottom: 15px;
      -webkit-overflow-scrolling: touch; /* For smooth scrolling on iOS */
      scrollbar-width: thin; /* Firefox */
      scrollbar-color: #004080 #f0f7ff; /* Firefox */
    }
    #recent-carousel-section .carousel-container::-webkit-scrollbar {
      height: 8px;
    }
    #recent-carousel-section .carousel-container::-webkit-scrollbar-thumb {
      background-color: #004080;
      border-radius: 10px;
    }
    #recent-carousel-section .carousel-container::-webkit-scrollbar-track {
      background-color: #f0f7ff;
    }

    #recent-carousel-section .carousel-card {
      flex: 0 0 auto;
      background: white;
      border-radius: 10px;
      width: 300px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      padding: 15px;
      position: relative;
    }
    #recent-carousel-section .view-btn {
      position: absolute;
      top: 10px;
      right: 10px;
    }
    @media (max-width: 480px) {
      #recent-carousel-section .container {
        display: block !important;
      }
      #recent-carousel-section .carousel-card {
        width: 280px;
      }
    }
    #recent-carousel-section .no-data {
      text-align: center;
      padding: 20px;
      color: gray;
      font-style: italic;
      width: 100%;
    }

    /* Styles from Page 4 (Magazine Table) */
    #magazine-table-section .detail-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 20px;
      max-width: 600px;
      margin: 0 auto 30px;
      display: none;
      position: relative;
    }
    #magazine-table-section .close-btn {
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 14px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      padding: 5px 10px;
      cursor: pointer;
    }
    #magazine-table-section .close-btn:hover {
      background: #bb2d3b;
    }
    #magazine-table-section .page-btn {
      margin: 0 5px;
      padding: 6px 12px;
      background: #004080;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #magazine-table-section .page-btn:hover {
      background: #0066cc;
    }
    @media (max-width: 576px) {
      #magazine-table-section body {
        padding: 10px;
      }
      #magazine-table-section .table-responsive {
        overflow-x: auto;
      }
    }

    /* Common Modal/View Card Styles */
    .view-card {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
      align-items: center;
      justify-content: center;
    }
    .view-card-content {
      background: #fff;
      padding: 20px;
      max-width: 500px;
      border-radius: 10px;
      width: 90%;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
      scroll-behavior: smooth;
    }
    .view-close {
      position: absolute;
      top: 10px; right: 15px;
      cursor: pointer;
      font-size: 1.2em;
      color: red;
    }

    /* Footer Styles */
    footer {
      background-color: #003366;
      color: white;
      text-align: center;
      padding: 10px 20px;
      margin-top: auto; /* Push footer to the bottom */
      box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <header>
    <h1>NJK PROPERTY</h1>
    <p>THE REAL ESTATE MAGAZINE</p>
  </header>

  <nav>
    <button onclick="showPage('submit-property-section')">Submit Property</button>
    <button onclick="showPage('archive-section')">Archive</button>
    <button onclick="showPage('recent-carousel-section')">Recent Posts</button>
    <button onclick="showPage('magazine-table-section')">Magazine View</button>
  </nav>

  <div id="submit-property-section" class="page-section">
    <h2>Submit New Property</h2>
    <form id="propertyForm">
      <label>Property Title</label>
      <input type="text" name="title" required />

      <label>Property Description</label>
      <textarea name="description" required></textarea>

      <label>Property Type</label>
      <select name="type" id="type">
        <option>Plot</option>
        <option>Bungalow</option>
        <option>Flat</option>
        <option>Shop</option>
        <option>Basement</option>
        <option>Office</option>
        <option>Warehouse</option>
      </select>

      <label>Purpose</label>
      <select name="purpose">
        <option>Rent</option>
        <option>Sale</option>
      </select>

      <label>Location</label>
      <select name="location">
        <option>DHA PHASE</option>
        <option>COMMERCIAL AREA</option>
        <option>CLIFTON BLOCK</option>
        <option>KORANGI INDUSTRIAL AREA SECTOR</option>
      </select>
      <input type="text" name="locationInput" placeholder="Enter Phase, Block or Sector" />

      <label>Area Unit</label>
      <select name="areaUnit" id="areaUnit">
        <option>SQFT</option>
        <option>SQYDS</option>
      </select>
      <input type="number" name="areaValue" placeholder="Enter area" required />

      <div id="bedBath" class="hidden">
        <label>Bedrooms</label>
        <input type="number" name="bedrooms" id="bedrooms" />

        <label>Bathrooms</label>
        <input type="number" name="bathrooms" id="bathrooms" />
      </div>

      <label>Price</label>
      <input type="number" name="price" required />

      <label>Agency Name</label>
      <input type="text" name="agency" required />

      <label>Agent Name</label>
      <input type="text" name="agent" required />

      <label>Contact</label>
      <input type="text" name="contact" required />

      <button type="submit">Submit Property</button>
    </form>
    <p id="submitMsg" style="display:none;">‚úÖ Property submitted successfully!</p>
  </div>

  <div id="archive-section" class="page-section">
    <div class="container">
      <h2 class="text-center mb-4">üè° NJK PROPERTY | ARCHIVE</h2>
      <div class="row g-2 justify-content-center mb-4">
        <div class="col-md-2">
          <select class="form-select" id="filterTypeArchive" onchange="toggleBedroomsFilter('archive')">
            <option value="">All Types</option><option>Plot</option><option>Bungalow</option><option>Flat</option><option>Shop</option><option>Basement</option><option>Office</option><option>Warehouse</option>
          </select>
        </div>
        <div class="col-md-2"><select class="form-select" id="filterPurposeArchive">
          <option value="">All Purposes</option><option>Rent</option><option>Sale</option>
        </select></div>
        <div class="col-md-2">
          <input type="text" class="form-control" id="filterLocationArchive" placeholder="Location" list="locationListArchive" />
          <datalist id="locationListArchive"></datalist>
        </div>
        <div class="col-md-2 filter-item bedrooms-filter" id="bedroomsFilterArchive">
          <input type="number" class="form-control" id="filterBedroomsArchive" placeholder="Bedrooms" />
        </div>
        <div class="col-md-2"><input type="number" class="form-control" id="minAreaArchive" placeholder="Min Area" /></div>
        <div class="col-md-2"><input type="number" class="form-control" id="maxAreaArchive" placeholder="Max Area" /></div>
        <div class="col-md-2"><input type="text" class="form-control" id="keywordArchive" placeholder="Keyword" /></div>
        <div class="col-md-2">
          <input type="date" class="form-control" id="filterDateArchive" placeholder="Filter by date" title="Filter by date" />
        </div>
        <div class="col-md-2"><input type="number" class="form-control" id="minPriceArchive" placeholder="Min Price" /></div>
        <div class="col-md-2"><input type="number" class="form-control" id="maxPriceArchive" placeholder="Max Price" /></div>
        <div class="col-md-2"><button class="btn btn-primary w-100" onclick="applyFiltersArchive()">üîç Filter</button></div>
      </div>

      <div class="archive-list" id="archiveList"></div>
      <nav class="mt-4"><ul class="pagination justify-content-center" id="paginationArchive"></ul></nav>
    </div>
  </div>

  <div id="recent-carousel-section" class="page-section">
    <div class="container">
      <h2 class="text-center mb-4">üÜï NJK PROPERTY | RECENT POSTS</h2>
      <div id="carousel-filters" class="row g-2 justify-content-center mb-4">
        <div class="col-md-2">
          <select class="form-select" id="filterTypeCarousel" onchange="toggleBedroomsFilter('carousel')">
            <option value="">All Types</option><option>Plot</option><option>Bungalow</option><option>Flat</option><option>Shop</option><option>Basement</option><option>Office</option><option>Warehouse</option>
          </select>
        </div>
        <div class="col-md-2"><select class="form-select" id="filterPurposeCarousel">
          <option value="">All Purposes</option><option>Rent</option><option>Sale</option>
        </select></div>
        <div class="col-md-2">
          <input type="text" class="form-control" id="filterLocationCarousel" placeholder="Location" list="locationListCarousel" />
          <datalist id="locationListCarousel"></datalist>
        </div>
        <div class="col-md-2 filter-item bedrooms-filter" id="bedroomsFilterCarousel">
          <input type="number" class="form-control" id="filterBedroomsCarousel" placeholder="Bedrooms" />
        </div>
        <div class="col-md-2"><input type="number" class="form-control" id="minAreaCarousel" placeholder="Min Area" /></div>
        <div class="col-md-2"><input type="number" class="form-control" id="maxAreaCarousel" placeholder="Max Area" /></div>
        <div class="col-md-2"><input type="text" class="form-control" id="keywordCarousel" placeholder="Keyword" /></div>
        <div class="col-md-2"><button class="btn btn-primary w-100" onclick="applyCarouselFilters()">üîç Filter</button></div>
      </div>
      <div class="carousel-container" id="carousel"></div>
    </div>
  </div>

  <div id="magazine-table-section" class="page-section">
    <div class="container-fluid">
      <h1 class="text-center mb-4">NJK PROPERTY | MAGAZINE VIEW</h1>
      <div class="row g-2 justify-content-center mb-4" id="filters">
        <div class="col-sm-6 col-md-2">
          <select id="filterTypeMagazine" class="form-select" onchange="toggleBedroomsFilter('magazine')">
            <option value="">All Types</option>
            <option>Plot</option>
            <option>Bungalow</option>
            <option>Flat</option>
            <option>Shop</option>
            <option>Basement</option>
            <option>Office</option>
            <option>Warehouse</option>
          </select>
        </div>
        <div class="col-sm-6 col-md-2">
          <select id="filterPurposeMagazine" class="form-select">
            <option value="">All Purposes</option>
            <option>Rent</option>
            <option>Sale</option>
          </select>
        </div>
        <div class="col-sm-6 col-md-2">
          <input type="number" id="minPriceMagazine" class="form-control" placeholder="Min Price" />
        </div>
        <div class="col-sm-6 col-md-2">
          <input type="number" id="maxPriceMagazine" class="form-control" placeholder="Max Price" />
        </div>
        <div class="col-sm-6 col-md-2 filter-item bedrooms-filter" id="bedroomsFilterMagazine">
          <input type="number" id="bedroomCountMagazine" class="form-control" placeholder="Bedrooms" />
        </div>
        <div class="col-sm-6 col-md-2">
          <input type="number" class="form-control" id="minAreaMagazine" placeholder="Min Area" />
        </div>
        <div class="col-sm-6 col-md-2">
          <input type="number" class="form-control" id="maxAreaMagazine" placeholder="Max Area" />
        </div>
        <div class="col-sm-6 col-md-2">
          <input type="text" id="filterLocationMagazine" list="locationListMagazine" class="form-control" placeholder="Location" />
          <datalist id="locationListMagazine"></datalist>
        </div>
        <div class="col-sm-6 col-md-2">
          <input type="date" class="form-control" id="filterDateMagazine" placeholder="Filter by date" title="Filter by date" />
        </div>
        <div class="col-sm-6 col-md-3">
          <input type="text" id="keywordMagazine" class="form-control" placeholder="Keyword in Description" />
        </div>
        <div class="col-sm-6 col-md-2">
          <button class="btn btn-primary w-100" onclick="applyFiltersMagazine()">üîç Filter</button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered">
          <thead class="table-dark">
            <tr><th>Title</th><th>Type</th><th>Purpose</th><th>Area</th><th>Price</th><th>Location</th><th>Agency</th><th>Agent</th><th>View</th></tr>
          </thead>
          <tbody id="propertyTableMagazine"></tbody>
        </table>
      </div>

      <div id="paginationMagazine" class="text-center"></div>
    </div>
  </div>

  <div class="view-card" id="commonViewCard">
    <div class="view-card-content" id="commonCardContent">
      <span class="view-close" onclick="closeCommonView()">&times;</span>
      <div id="commonCardDetails"></div>
    </div>
  </div>

  <footer>
    Project by "NJK REAL ESTATE"
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbyfLqoYInc6hMXn5Bsbh8VUPlbcDZO7LiYgwHggdEYrRU-1HMYogLBOu0gPAS94AMNo/exec";

    // --- SPA Navigation Logic ---
    function showPage(pageId) {
      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top when changing page

      // Trigger data loading when a page is shown for the first time or re-shown
      if (pageId === 'archive-section') {
        if (!document.getElementById('archiveList').hasChildNodes()) { // Only load if not already loaded
          loadPostsArchive();
        }
      } else if (pageId === 'recent-carousel-section') {
        if (!document.getElementById('carousel').hasChildNodes() || document.getElementById('carousel').querySelector('.no-data')) { // Only load if not already loaded or if no data was found previously
          loadCarouselRecent();
        }
      } else if (pageId === 'magazine-table-section') {
        if (!document.getElementById('propertyTableMagazine').hasChildNodes()) { // Only load if not already loaded
          fetchDataMagazine();
        }
      }
    }

    // --- Page 1: Submit Property Logic ---
    const typeFieldSubmit = document.getElementById('type');
    const bedBathDivSubmit = document.getElementById('bedBath');

    typeFieldSubmit.addEventListener('change', () => {
      const val = typeFieldSubmit.value;
      if (val === 'Bungalow' || val === 'Flat') {
        bedBathDivSubmit.classList.remove('hidden');
      } else {
        bedBathDivSubmit.classList.add('hidden');
      }
    });

    document.getElementById("propertyForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const form = e.target;
      const data = new FormData(form);
      fetch(ENDPOINT, {
        method: "POST",
        body: data
      })
      .then(res => res.json())
      .then(res => {
        if (res.status === "success") {
          document.getElementById("submitMsg").style.display = "block";
          form.reset();
          bedBathDivSubmit.classList.add('hidden');
          // Optionally reload data for other sections after submission
          loadPostsArchive();
          loadCarouselRecent();
          fetchDataMagazine();
        } else {
          alert("‚ùå Failed to submit: " + res.message);
        }
      })
      .catch(err => {
        alert("‚ùå Submission Error");
        console.error(err);
      });
    });

    // --- Conditional Bedrooms Filter Visibility ---
    function toggleBedroomsFilter(section) {
      const typeSelect = document.getElementById(`filterType${section.charAt(0).toUpperCase() + section.slice(1)}`);
      const bedroomsFilterDiv = document.getElementById(`bedroomsFilter${section.charAt(0).toUpperCase() + section.slice(1)}`);

      if (typeSelect.value === 'Bungalow' || typeSelect.value === 'Flat') {
        bedroomsFilterDiv.style.display = 'block'; // Show the filter
      } else {
        bedroomsFilterDiv.style.display = 'none'; // Hide the filter
        // Optionally clear the bedrooms input when hidden
        const bedroomsInput = bedroomsFilterDiv.querySelector('input[type="number"]');
        if (bedroomsInput) bedroomsInput.value = '';
      }
    }

    // --- Common Filter Clear Function ---
    function clearFilters(section) {
      const filterPrefix = section.charAt(0).toUpperCase() + section.slice(1);
      const filterIds = [
        `filterType${filterPrefix}`, `filterPurpose${filterPrefix}`,
        `filterLocation${filterPrefix}`, `filterBedrooms${filterPrefix}`,
        `minArea${filterPrefix}`, `maxArea${filterPrefix}`,
        `keyword${filterPrefix}`, `filterDate${filterPrefix}`,
        `minPrice${filterPrefix}`, `maxPrice${filterPrefix}`
      ];
      filterIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          if (element.tagName === 'SELECT') {
            element.value = ''; // Reset select to first option (All)
          } else if (element.type === 'date' || element.type === 'text' || element.type === 'number') {
            element.value = ''; // Clear text/number/date inputs
          }
        }
      });
      // Ensure bedrooms filter is hidden if type is not Bungalow/Flat after clearing
      toggleBedroomsFilter(section.toLowerCase()); // Pass lower case like 'archive'
    }

    // --- Common View Card for Archive, Recent, Magazine ---
    function viewCommonCard(post) {
      const phone = post.Contact.toString().replace(/[^0-9]/g, "");
      
      let bedroomInfo = '';
      let bathroomInfo = '';
      if (post.Type === 'Bungalow' || post.Type === 'Flat') {
          bedroomInfo = `Bedrooms: ${post.Bedrooms || 'N/A'}\n`;
          bathroomInfo = `Bathrooms: ${post.Bathrooms || 'N/A'}\n`;
      }

      const fullDetails = `Hello ${post.Agent},\n\nI'm interested in your property ad:\n\n` +
                          `Title: ${post.Title}\n` +
                          `Description: ${post.Description}\n` +
                          `Type: ${post.Type}\n` +
                          `Purpose: ${post.Purpose}\n` +
                          `Location: ${post.Location} ${post.LocationInput || ''}\n` +
                          `Area: ${post.AreaValue} ${post.AreaUnit}\n` +
                          `${bedroomInfo}` + // Conditionally add bedroom info for WhatsApp
                          `${bathroomInfo}` + // Conditionally add bathroom info for WhatsApp
                          `Price: ${post.Price}\n` +
                          `Agency: ${post.Agency}\n` +
                          `Posted On: ${new Date(post.Date).toLocaleDateString()}\n\n` +
                          `Please share more details.`;

      const message = encodeURIComponent(fullDetails);
      const link = phone.length >= 10 ? `https://wa.me/${phone}?text=${message}` : `sms:${phone}?body=${message}`;
      
      // Build HTML for the card, conditionally including bedrooms/bathrooms for the popup view
      let cardDetailsHTML = `
        <h4>${post.Title}</h4>
        <p><strong>Description:</strong> ${post.Description}</p>
        <p><strong>Type:</strong> ${post.Type}</p>
        <p><strong>Purpose:</strong> ${post.Purpose}</p>
        <p><strong>Area:</strong> ${post.AreaValue} ${post.AreaUnit}</p>
      `;
      if (post.Type === 'Bungalow' || post.Type === 'Flat') {
        cardDetailsHTML += `<p><strong>Bedrooms:</strong> ${post.Bedrooms || 'N/A'}</p>
                           <p><strong>Bathrooms:</strong> ${post.Bathrooms || 'N/A'}</p>`;
      }
      cardDetailsHTML += `
        <p><strong>Agency:</strong> ${post.Agency}</p>
        <p><strong>Agent:</strong> ${post.Agent}</p>
        <p><strong>Posted On:</strong> ${new Date(post.Date).toLocaleDateString()}</p>
        <a href="${link}" class="btn btn-success w-100" target="_blank">Contact via WhatsApp</a>`;

      document.getElementById("commonCardDetails").innerHTML = cardDetailsHTML;
      document.getElementById("commonViewCard").style.display = "flex";
    }

    function closeCommonView() {
      document.getElementById("commonViewCard").style.display = "none";
    }

    // --- Page 2: Archive Logic ---
    let allPostsArchive = [], filteredPostsArchive = [], currentPageArchive = 1;
    const perPageArchive = 21;

    async function loadPostsArchive() {
      try {
        const res = await fetch(ENDPOINT);
        const json = await res.json();
        if (json.status === "success") {
          allPostsArchive = json.data.reverse();
          populateLocationSuggestions('archive', allPostsArchive);
          applyFiltersArchive(); // Apply filters immediately after loading, including default date
        } else {
          document.getElementById("archiveList").innerHTML = '<div class="no-data">Failed to load posts.</div>';
        }
      } catch (error) {
        console.error("Fetch failed for Archive:", error);
        document.getElementById("archiveList").innerHTML = '<div class="no-data">Error loading posts. Please try again later.</div>';
      }
    }

    function renderListArchive() {
      const start = (currentPageArchive - 1) * perPageArchive;
      const paginated = filteredPostsArchive.slice(start, start + perPageArchive);
      const list = document.getElementById("archiveList");
      list.innerHTML = paginated.map(post => `
        <div class="archive-item">
          <h5>${post.Title}</h5>
          <p><strong>Type:</strong> ${post.Type}</p>
          <p><strong>Area:</strong> ${post.AreaValue || 'N/A'} ${post.AreaUnit || ''}</p>
          <p><strong>Price:</strong> ${post.Price}</p>
          <p><strong>Location:</strong> ${post.Location} ${post.LocationInput || ''}</p>
          <button class="btn btn-sm btn-outline-success" onclick='viewCommonCard(${JSON.stringify(post)})'>View</button>
        </div>`).join("");
      renderPaginationArchive();
    }

    function renderPaginationArchive() {
      const total = Math.ceil(filteredPostsArchive.length / perPageArchive);
      const pagination = document.getElementById("paginationArchive");
      pagination.innerHTML = "";
      for (let i = 1; i <= total; i++) {
        pagination.innerHTML += `<li class="page-item ${i === currentPageArchive ? 'active' : ''}"><a class="page-link" href="#" onclick="gotoPageArchive(${i})">${i}</a></li>`;
      }
    }

    function gotoPageArchive(p) {
      currentPageArchive = p;
      renderListArchive();
      document.getElementById('archive-section').scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top of section
    }

    function applyFiltersArchive() {
      const type = document.getElementById("filterTypeArchive").value;
      const purpose = document.getElementById("filterPurposeArchive").value;
      const location = document.getElementById("filterLocationArchive").value.toLowerCase();
      const keyword = document.getElementById("keywordArchive").value.toLowerCase();
      const dateFilter = document.getElementById("filterDateArchive").value;
      const minPrice = document.getElementById("minPriceArchive").value;
      const maxPrice = document.getElementById("maxPriceArchive").value;
      const bedrooms = document.getElementById("filterBedroomsArchive").value;
      const minArea = document.getElementById("minAreaArchive").value;
      const maxArea = document.getElementById("maxAreaArchive").value;

      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

      filteredPostsArchive = allPostsArchive.filter(post => {
        const loc = `${post.Location} ${post.LocationInput || ''}`.toLowerCase();
        const postDate = new Date(post.Date);
        const price = parseFloat(post.Price) || 0;
        const postBedrooms = parseInt(post.Bedrooms || 0);
        const postAreaValue = parseFloat(post.AreaValue) || 0;

        let dateCondition = true;
        if (dateFilter) {
          dateCondition = postDate.toISOString().split("T")[0] === dateFilter;
        } else {
          // Default: only show posts from the last 30 days if no specific date is picked
          dateCondition = postDate >= thirtyDaysAgo;
        }

        let bedroomCondition = true;
        if (type === 'Bungalow' || type === 'Flat') {
            bedroomCondition = bedrooms === "" || postBedrooms === parseInt(bedrooms);
        }

        return (
          (type === "" || post.Type === type) &&
          (purpose === "" || post.Purpose === purpose) &&
          (location === "" || loc.includes(location)) &&
          (keyword === "" || (post.Description && post.Description.toLowerCase().includes(keyword))) &&
          (dateCondition) &&
          (minPrice === "" || price >= parseFloat(minPrice)) &&
          (maxPrice === "" || price <= parseFloat(maxPrice)) &&
          (bedroomCondition) && // Use the conditional bedroom
          (minArea === "" || postAreaValue >= parseFloat(minArea)) &&
          (maxArea === "" || postAreaValue <= parseFloat(maxArea))
        );
      });
      currentPageArchive = 1;
      renderListArchive();
      clearFilters('Archive'); // Clear filters after applying
    }

    // --- Page 3: Recent Carousel Logic ---
    let allPostsCarousel = [];

    async function loadCarouselRecent() {
      try {
        const res = await fetch(ENDPOINT);
        const json = await res.json();
        if (json.status === "success" && json.data.length > 0) {
          allPostsCarousel = json.data.reverse().slice(0, 30); // Limit to 30 recent posts
          populateLocationSuggestions('carousel', allPostsCarousel);
          renderCarouselRecent(allPostsCarousel); // Initial render without filters
        } else {
          renderCarouselRecent([]);
        }
      } catch (error) {
        console.error("Fetch failed for Carousel:", error);
        document.getElementById("carousel").innerHTML = '<div class="no-data">Error loading recent posts.</div>';
      }
    }

    function renderCarouselRecent(data) {
      const container = document.getElementById("carousel");
      container.innerHTML = "";
      if (data.length === 0) {
        container.innerHTML = '<div class="no-data">No recent records found.</div>';
        return;
      }
      data.forEach(post => {
        const card = document.createElement("div");
        card.className = "carousel-card";
        card.innerHTML = `
          <h5>${post.Title}</h5>
          <p><strong>Type:</strong> ${post.Type}</p>
          <p><strong>Area:</strong> ${post.AreaValue || 'N/A'} ${post.AreaUnit || ''}</p>
          <p><strong>Price:</strong> ${post.Price}</p>
          <p><strong>Location:</strong> ${post.Location} ${post.LocationInput || ''}</p>
          <p><strong>Purpose:</strong> ${post.Purpose}</p>
          <button class="btn btn-outline-primary btn-sm view-btn" onclick='viewCommonCard(${JSON.stringify(post)})'>View</button>
        `;
        container.appendChild(card);
      });
    }

    function applyCarouselFilters() {
      const type = document.getElementById("filterTypeCarousel").value;
      const purpose = document.getElementById("filterPurposeCarousel").value;
      const location = document.getElementById("filterLocationCarousel").value.toLowerCase();
      const keyword = document.getElementById("keywordCarousel").value.toLowerCase();
      const bedrooms = document.getElementById("filterBedroomsCarousel").value;
      const minArea = document.getElementById("minAreaCarousel").value;
      const maxArea = document.getElementById("maxAreaCarousel").value;

      const filtered = allPostsCarousel.filter(post => {
        const loc = `${post.Location} ${post.LocationInput || ''}`.toLowerCase();
        const postBedrooms = parseInt(post.Bedrooms || 0);
        const postAreaValue = parseFloat(post.AreaValue) || 0;

        let bedroomCondition = true;
        if (type === 'Bungalow' || type === 'Flat') {
            bedroomCondition = bedrooms === "" || postBedrooms === parseInt(bedrooms);
        }

        return (
          (type === "" || post.Type === type) &&
          (purpose === "" || post.Purpose === purpose) &&
          (location === "" || loc.includes(location)) &&
          (keyword === "" || (post.Description && post.Description.toLowerCase().includes(keyword))) &&
          (bedroomCondition) && // Use the conditional bedroom
          (minArea === "" || postAreaValue >= parseFloat(minArea)) &&
          (maxArea === "" || postAreaValue <= parseFloat(maxArea))
        );
      });
      renderCarouselRecent(filtered);
      document.getElementById('recent-carousel-section').scrollTo({ top: document.getElementById("carousel").offsetTop - 40, behavior: "smooth" });
      clearFilters('Carousel'); // Clear filters after applying
    }

    // --- Page 4: Magazine Table Logic ---
    const ITEMS_PER_PAGE_MAGAZINE = 10;
    let currentPageMagazine = 1;
    let allDataMagazine = [], filteredDataMagazine = [];

    async function fetchDataMagazine() {
      try {
        const res = await fetch(ENDPOINT);
        const json = await res.json();
        if (json.status === "success") {
          allDataMagazine = json.data.reverse();
          populateLocationSuggestions('magazine', allDataMagazine);
          applyFiltersMagazine(); // Apply filters immediately after loading, including default date
        } else {
          document.getElementById("propertyTableMagazine").innerHTML = '<tr><td colspan="9" class="text-center">Failed to load data.</td></tr>';
        }
      } catch (error) {
        console.error("Fetch failed for Magazine Table:", error);
        document.getElementById("propertyTableMagazine").innerHTML = '<tr><td colspan="9" class="text-center">Error loading data. Please try again later.</td></tr>';
      }
    }

    function populateLocationSuggestions(section, data) {
      const locationSet = new Set();
      data.forEach(item => {
        const fullLoc = `${item.Location} ${item.LocationInput || ''}`.trim();
        if (fullLoc) locationSet.add(fullLoc);
      });
      const datalist = document.getElementById(`locationList${section.charAt(0).toUpperCase() + section.slice(1)}`);
      if (datalist) { // Ensure datalist exists
        datalist.innerHTML = "";
        [...locationSet].forEach(loc => {
          const option = document.createElement("option");
          option.value = loc;
          datalist.appendChild(option);
        });
      }
    }


    function applyFiltersMagazine() {
      const type = document.getElementById("filterTypeMagazine").value;
      const purpose = document.getElementById("filterPurposeMagazine").value;
      const minPrice = document.getElementById("minPriceMagazine").value;
      const maxPrice = document.getElementById("maxPriceMagazine").value;
      const bedrooms = document.getElementById("bedroomCountMagazine").value;
      const minArea = document.getElementById("minAreaMagazine").value;
      const maxArea = document.getElementById("maxAreaMagazine").value;
      const location = document.getElementById("filterLocationMagazine").value.toLowerCase();
      const keyword = document.getElementById("keywordMagazine").value.toLowerCase();
      const dateFilter = document.getElementById("filterDateMagazine").value;

      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

      filteredDataMagazine = allDataMagazine.filter(item => {
        const fullLoc = `${item.Location} ${item.LocationInput || ''}`.toLowerCase();
        const price = parseFloat(item.Price) || 0;
        const postBedrooms = parseInt(item.Bedrooms || 0);
        const postAreaValue = parseFloat(item.AreaValue) || 0;
        const postDate = new Date(item.Date);

        let dateCondition = true;
        if (dateFilter) {
          dateCondition = postDate.toISOString().split("T")[0] === dateFilter;
        } else {
          // Default: only show posts from the last 30 days if no specific date is picked
          dateCondition = postDate >= thirtyDaysAgo;
        }

        let bedroomCondition = true;
        if (type === 'Bungalow' || type === 'Flat') {
            bedroomCondition = bedrooms === "" || postBedrooms === parseInt(bedrooms);
        }

        return (
          (type === "" || item.Type === type) &&
          (purpose === "" || item.Purpose === purpose) &&
          (minPrice === "" || price >= parseFloat(minPrice)) &&
          (maxPrice === "" || price <= parseFloat(maxPrice)) &&
          (bedroomCondition) && // Use the conditional bedroom
          (minArea === "" || postAreaValue >= parseFloat(minArea)) &&
          (maxArea === "" || postAreaValue <= parseFloat(maxArea)) &&
          (location === "" || fullLoc.includes(location)) &&
          (keyword === "" || (item.Description && item.Description.toLowerCase().includes(keyword))) &&
          (dateCondition)
        );
      });
      currentPageMagazine = 1;
      renderPageMagazine(currentPageMagazine);
      renderPaginationMagazine();
      clearFilters('Magazine'); // Clear filters after applying
    }

    function renderPageMagazine(page) {
      const start = (page - 1) * ITEMS_PER_PAGE_MAGAZINE;
      const end = start + ITEMS_PER_PAGE_MAGAZINE;
      const items = filteredDataMagazine.slice(start, end);
      const tbody = document.getElementById("propertyTableMagazine");
      tbody.innerHTML = "";
      if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">No records found matching filters.</td></tr>';
        return;
      }
      items.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.Title}</td>
          <td>${item.Type}</td>
          <td>${item.Purpose}</td>
          <td>${item.AreaValue || 'N/A'} ${item.AreaUnit || ''}</td>
          <td>${item.Price}</td>
          <td>${item.Location} ${item.LocationInput || ''}</td>
          <td>${item.Agency}</td>
          <td>${item.Agent}</td>
          <td><button class="btn btn-sm btn-primary" onclick='viewCommonCard(${JSON.stringify(item)})'>View</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderPaginationMagazine() {
      const totalPages = Math.ceil(filteredDataMagazine.length / ITEMS_PER_PAGE_MAGAZINE);
      const container = document.getElementById("paginationMagazine");
      container.innerHTML = "";
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.className = "page-btn";
        btn.textContent = i;
        btn.onclick = () => {
          currentPageMagazine = i;
          renderPageMagazine(i);
          document.getElementById('magazine-table-section').scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top of section
        };
        container.appendChild(btn);
      }
    }

    // Initialize the SPA by showing the default page (Archive)
    document.addEventListener('DOMContentLoaded', () => {
      showPage('archive-section');
      // Initialize bedroom filter visibility on page load for all sections
      toggleBedroomsFilter('archive');
      toggleBedroomsFilter('carousel');
      toggleBedroomsFilter('magazine');
    });
  </script>
</body>
</html>
